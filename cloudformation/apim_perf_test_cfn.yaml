# ----------------------------------------------------------------------------
#
# Copyright (c) 2018, WSO2 Inc. (http://wso2.org) All Rights Reserved.
#
# WSO2 Inc. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# ----------------------------------------------------------------------------
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  AWS CloudFormation Template to run APIM Performance Tests. This template
  creates Amazon EC2 instance in a VPC. The JMeter Client EC2 instance will be in a
  public subnet with a public IP. All other EC2 instances will be in a private subnet.
  **WARNING** This template creates multiple Amazon AWS resources. You will be
  billed for the AWS resources used if you create a stack from this template.
##############################################################################################
# Mappings for Ubuntu AMIs.
# Refer https://cloud-images.ubuntu.com/locator/ec2/ for ubuntu AMI-ID's for the LTS version
# Search using "bionic us- hvm:ebs-ssd"
##############################################################################################
Mappings:
  AWSRegion2AMI:
    us-east-1:
      AMI: ami-0977029b5b13f3d08
    us-east-2:
      AMI: ami-05f39e7b7f153bc6a
    us-west-1:
      AMI: ami-03d5270fcb641f79b
    us-west-2:
      AMI: ami-0f47ef92b4218ec09
#############################
# User inputs
#############################
Parameters:
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: 'AWS::EC2::KeyPair::KeyName'
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  TestName:
    Description: Name of the tests
    Type: String
    Default: APIM Performance Tests
  BucketName:
    Description: Name of bucket containing files
    Type: String
  BucketRegion:
    Description: The region of the bucket
    Type: String
  PerformanceAPIMDistributionName:
    Description: The name of the 'Performance APIM Distribution' package in S3 Bucket.
    Type: String
  APIMDistributionName:
    Description: The name of the 'APIM Distribution' in S3 Bucket
    Type: String
  JMeterDistributionName:
    Description: The name of the 'Apache JMeter distribution' in S3 Bucket.
    Type: String
    ConstraintDescription: must be a valid tgz package
    AllowedPattern: ^.*\.tgz$
  MysqlConnectorDistributionName:
    Description: The name of the Mysql connector jar in the S3 Backet
    Type: String
  OracleJDKDistributionName:
    Description: The name of the 'Oracle JDK Distribution' in S3 Bucket.
    Type: String
    ConstraintDescription: must be a valid Oracle JDK
    AllowedPattern: ^jdk-8u[0-9]+-linux-x64.tar.gz$
  DBInstanceClass:
    Description: DB Inastance class for RDS Instance
    Type: String
  MasterUsername:
    Description: Username of RDS DB Instance
    Type: String
  MasterUserPassword:
    Description: Password of RDS DB Instance
    Type: String
  OSUser:
    Description: Username of the general OS user
    Type: String
  JMeterClientInstanceType:
    Description: JMeter Client EC2 instance type
    Type: String
  JMeterServerInstanceType:
    Description: JMeter Server EC2 instance type
    Type: String
  APIMInstanceType:
    Description: APIM EC2 instance type
    Type: String
  BackendInstanceType:
    Description: Backend EC2 instance type
    Type: String
################################
# Create AWS resources
################################
Resources:
  #########################################
  # Create IAM resources to read S3 bucket
  #########################################
  CfnUser:
    Type: 'AWS::IAM::User'
    Properties:
      Path: /
      Policies:
        - PolicyName: root
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - 'cloudformation:DescribeStackResource'
                  - 's3:GetObject'
                Resource: '*'
  CfnKeys:
    Type: 'AWS::IAM::AccessKey'
    Properties:
      UserName: !Ref CfnUser
  BucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      PolicyDocument:
        Version: 2008-10-17
        Id: MyPolicy
        Statement:
          - Sid: ReadAccess
            Action:
              - 's3:GetObject'
            Effect: Allow
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref BucketName
                - /*
            Principal:
              AWS: !GetAtt
                - CfnUser
                - Arn
      Bucket: !Ref BucketName
  ####################################################################
  # Create IAM resources to configure AWS Logs Agent in EC2 instances
  ####################################################################
  LogRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: LogRolePolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                  - 'logs:DescribeLogStreams'
                Resource: 'arn:aws:logs:*:*:*'
  LogRoleInstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !Ref LogRole
  # Logs Group
  CloudFormationLogs:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName: !Join
        - '-'
        - - !Ref AWS::StackName
          - 'CloudFormationLogs'
      RetentionInDays: 7
  ##########################################################################################
  # Create VPC, public subnet and private subnet
  # https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Scenario2.html
  # https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Internet_Gateway.html
  ##########################################################################################
  VPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Join
            - ':'
            - - 'VPC'
              - !Ref TestName
  # Configure Public Subnet
  PublicSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select
        - 0
        - Fn::GetAZs: !Ref 'AWS::Region'
      CidrBlock: 10.0.0.0/24
      Tags:
        - Key: Name
          Value: !Join
            - ':'
            - - 'PublicSubnet'
              - !Ref TestName
  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties:
      Tags:
        - Key: Name
          Value: !Join
            - ':'
            - - 'InternetGateway'
              - !Ref TestName
  AttachGateway:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway
  PublicRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Join
            - ':'
            - - 'PublicRouteTable'
              - !Ref TestName
  PublicRoute:
    Type: 'AWS::EC2::Route'
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
  PublicSubnetRouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable
  # Configure Private Subnet
  PrivateSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select
        - 0
        - Fn::GetAZs: !Ref 'AWS::Region'
      CidrBlock: 10.0.1.0/24
      Tags:
        - Key: Name
          Value: !Join
            - ':'
            - - 'PrivateSubnet'
              - !Ref TestName
  PrivateSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select
        - 1
        - Fn::GetAZs: !Ref 'AWS::Region'
      CidrBlock: 10.0.2.0/24
      Tags:
      - Key: Name
        Value: !Join
        - ':'
        - - 'PrivateSubnet2'
          - !Ref TestName
  NatGateway:
    Type: 'AWS::EC2::NatGateway'
    DependsOn: AttachGateway
    Properties:
      AllocationId: !GetAtt
        - NatGatewayIPAddress
        - AllocationId
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: !Join
            - ':'
            - - 'NatGateway'
              - !Ref TestName
  NatGatewayIPAddress:
    Type: 'AWS::EC2::EIP'
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
  PrivateRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Join
            - ':'
            - - 'PrivateRouteTable'
              - !Ref TestName
  PrivateRoute:
    Type: 'AWS::EC2::Route'
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway
  PrivateSubnetRouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable
  PrivateSubnet2RouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable
  InstanceSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      VpcId: !Ref VPC
      GroupDescription: Security Group for EC2 instances
      SecurityGroupIngress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
  APIMDBSubnetGroup:
    Type: "AWS::RDS::DBSubnetGroup"
    Properties:
      DBSubnetGroupDescription: "Subnet group for AWS RDS"
      SubnetIds:
        - !Ref PrivateSubnet
        - !Ref PrivateSubnet2
  #######################
  # EC2 Instances
  #######################
  JMeterClientInstance:
    Type: 'AWS::EC2::Instance'
    DependsOn: [AttachGateway, BucketPolicy]
    Metadata:
      'AWS::CloudFormation::Init':
        config:
          sources:
            /home/ubuntu: !Join
              - ''
              - - 'https://s3.'
                -  !Ref BucketRegion
                - '.amazonaws.com/'
                - !Ref BucketName
                - /
                - !Ref PerformanceAPIMDistributionName
          files:
            /etc/awslogs/awslogs.conf:
              content: !Sub |
                [general]
                state_file = /var/awslogs/state/agent-state

                [/var/log/cloud-init.log]
                file = /var/log/cloud-init.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-client/cloud-init.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cloud-init-output.log]
                file = /var/log/cloud-init-output.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-client/cloud-init-output.log
                datetime_format =

                [/var/log/cfn-init.log]
                file = /var/log/cfn-init.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-client/cfn-init.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cfn-init-cmd.log]
                file = /var/log/cfn-init-cmd.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-client/cfn-init-cmd.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cfn-wire.log]
                file = /var/log/cfn-wire.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-client/cfn-wire.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/syslog]
                file = /var/log/syslog
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-client/syslog
                datetime_format = %b %d %H:%M:%S
              mode: '000444'
              owner: root
              group: root
            /home/ubuntu/private_key.pem:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref KeyName
                  - .pem
              mode: '000600'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
            /home/ubuntu/apache-jmeter.tgz:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref JMeterDistributionName
              mode: '000664'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
            /home/ubuntu/jdk-8-linux-x64.tar.gz:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref OracleJDKDistributionName
              mode: '000664'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
          commands:
            01_create_state_directory:
              command: mkdir -p /var/awslogs/state
            02_download_awslogs_agent:
              command: curl -s https://s3.amazonaws.com/aws-cloudwatch/downloads/latest/awslogs-agent-setup.py -O
              cwd: /root
            03_change_permission:
              command: chmod +x ./awslogs-agent-setup.py
              cwd: /root
            04_install_awslogs_agent:
              command: !Join
                - ''
                - - './awslogs-agent-setup.py -n -r '
                  - !Ref 'AWS::Region'
                  - ' -c /etc/awslogs/awslogs.conf'
              cwd: /root
      'AWS::CloudFormation::Authentication':
        S3AccessCreds:
          type: S3
          accessKeyId: !Ref CfnKeys
          secretKey: !GetAtt
            - CfnKeys
            - SecretAccessKey
          buckets:
            - !Ref BucketName
    Properties:
      ImageId: !FindInMap [ AWSRegion2AMI, !Ref "AWS::Region", AMI ]
      InstanceType: !Ref JMeterClientInstanceType
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref LogRoleInstanceProfile
      BlockDeviceMappings:
        - DeviceName: "/dev/sda1"
          Ebs:
            VolumeSize: 100
      Tags:
        - Key: Name
          Value: !Join
            - ':'
            - - 'JMeter Client'
              - !Ref TestName
      NetworkInterfaces:
        - GroupSet:
            - !Ref InstanceSecurityGroup
          AssociatePublicIpAddress: 'true'
          DeviceIndex: '0'
          DeleteOnTermination: 'true'
          SubnetId: !Ref PublicSubnet
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          apt-get -y update
          # Install AWS CloudFormation Helper Scripts
          apt-get -y install python-pip
          mkdir aws-cfn-bootstrap-latest
          curl -s https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz -O
          pip install aws-cfn-bootstrap-latest.tar.gz
          tar xzf aws-cfn-bootstrap-latest.tar.gz -C  aws-cfn-bootstrap-latest --strip-components 1
          ln -s aws-cfn-bootstrap-latest/init/ubuntu/cfn-hup /etc/init.d/cfn-hup
          # Initialize
          /usr/local/bin/cfn-init -v --stack ${AWS::StackId} --resource JMeterClientInstance --region ${AWS::Region}
          # Must run setup script in User Data (Commands executed within cfn-init do not show the progress in logs)
          /home/ubuntu/setup/setup-jmeter-client.sh -g -k /home/ubuntu/private_key.pem \
            -i /home/ubuntu \
            -d /home/ubuntu/jdk-8-linux-x64.tar.gz \
            -f /home/ubuntu/apache-jmeter.tgz \
            -c /home/ubuntu \
            -a jmeter1 -n ${JMeterServer1Instance.PrivateIp} \
            -a jmeter2 -n ${JMeterServer2Instance.PrivateIp} \
            -a apim -n ${APIMInstance.PrivateIp} \
            -a netty -n ${BackendInstance.PrivateIp}
          # Signal
          /usr/local/bin/cfn-signal -e $? --stack ${AWS::StackId} --resource JMeterClientInstance --region ${AWS::Region}
    CreationPolicy:
      ResourceSignal:
        Timeout: PT30M
  JMeterServer1Instance:
    Type: 'AWS::EC2::Instance'
    DependsOn: [AttachGateway, BucketPolicy]
    Metadata:
      'AWS::CloudFormation::Init':
        config:
          sources:
            /home/ubuntu: !Join
              - ''
              - - 'https://s3.'
                -  !Ref BucketRegion
                - '.amazonaws.com/'
                - !Ref BucketName
                - /
                - !Ref PerformanceAPIMDistributionName
          files:
            /etc/awslogs/awslogs.conf:
              content: !Sub |
                [general]
                state_file = /var/awslogs/state/agent-state

                [/var/log/cloud-init.log]
                file = /var/log/cloud-init.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-server-1/cloud-init.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cloud-init-output.log]
                file = /var/log/cloud-init-output.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-server-1/cloud-init-output.log
                datetime_format =

                [/var/log/cfn-init.log]
                file = /var/log/cfn-init.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-server-1/cfn-init.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cfn-init-cmd.log]
                file = /var/log/cfn-init-cmd.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-server-1/cfn-init-cmd.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cfn-wire.log]
                file = /var/log/cfn-wire.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-server-1/cfn-wire.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/syslog]
                file = /var/log/syslog
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-server-1/syslog
                datetime_format = %b %d %H:%M:%S
              mode: '000444'
              owner: root
              group: root
            /home/ubuntu/private_key.pem:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref KeyName
                  - .pem
              mode: '000444'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
            /home/ubuntu/apache-jmeter.tgz:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref JMeterDistributionName
              mode: '000664'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
            /home/ubuntu/jdk-8-linux-x64.tar.gz:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref OracleJDKDistributionName
              mode: '000664'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
          commands:
            01_create_state_directory:
              command: mkdir -p /var/awslogs/state
            02_download_awslogs_agent:
              command: curl -s https://s3.amazonaws.com/aws-cloudwatch/downloads/latest/awslogs-agent-setup.py -O
              cwd: /root
            03_change_permission:
              command: chmod +x ./awslogs-agent-setup.py
              cwd: /root
            04_install_awslogs_agent:
              command: !Join
                - ''
                - - './awslogs-agent-setup.py -n -r '
                  - !Ref 'AWS::Region'
                  - ' -c /etc/awslogs/awslogs.conf'
              cwd: /root
      'AWS::CloudFormation::Authentication':
        S3AccessCreds:
          type: S3
          accessKeyId: !Ref CfnKeys
          secretKey: !GetAtt
            - CfnKeys
            - SecretAccessKey
          buckets:
            - !Ref BucketName
    Properties:
      ImageId: !FindInMap [ AWSRegion2AMI, !Ref "AWS::Region", AMI ]
      InstanceType: !Ref JMeterServerInstanceType
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref LogRoleInstanceProfile
      Tags:
        - Key: Name
          Value: !Join
              - ':'
              - - 'JMeter Server 1'
                - !Ref TestName
      NetworkInterfaces:
        - GroupSet:
            - !Ref InstanceSecurityGroup
          AssociatePublicIpAddress: 'false'
          DeviceIndex: '0'
          DeleteOnTermination: 'true'
          SubnetId: !Ref PrivateSubnet
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          apt-get -y update
          # Install AWS CloudFormation Helper Scripts
          apt-get -y install python-pip
          mkdir aws-cfn-bootstrap-latest
          curl -s https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz -O
          pip install aws-cfn-bootstrap-latest.tar.gz
          tar xzf aws-cfn-bootstrap-latest.tar.gz -C  aws-cfn-bootstrap-latest --strip-components 1
          ln -s aws-cfn-bootstrap-latest/init/ubuntu/cfn-hup /etc/init.d/cfn-hup
          # Initialize
          /usr/local/bin/cfn-init -v --stack ${AWS::StackId} --resource JMeterServer1Instance --region ${AWS::Region}
          # Run setup
          /home/ubuntu/setup/setup-jmeter.sh -g -i /home/ubuntu -d /home/ubuntu/jdk-8-linux-x64.tar.gz -f /home/ubuntu/apache-jmeter.tgz
          # Signal
          /usr/local/bin/cfn-signal -e $? --stack ${AWS::StackId} --resource JMeterServer1Instance --region ${AWS::Region}
    CreationPolicy:
      ResourceSignal:
        Timeout: PT30M
  JMeterServer2Instance:
    Type: 'AWS::EC2::Instance'
    DependsOn: [AttachGateway, BucketPolicy]
    Metadata:
      'AWS::CloudFormation::Init':
        config:
          sources:
            /home/ubuntu: !Join
              - ''
              - - 'https://s3.'
                -  !Ref BucketRegion
                - '.amazonaws.com/'
                - !Ref BucketName
                - /
                - !Ref PerformanceAPIMDistributionName
          files:
            /etc/awslogs/awslogs.conf:
              content: !Sub |
                [general]
                state_file = /var/awslogs/state/agent-state

                [/var/log/cloud-init.log]
                file = /var/log/cloud-init.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-server-2/cloud-init.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cloud-init-output.log]
                file = /var/log/cloud-init-output.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-server-2/cloud-init-output.log
                datetime_format =

                [/var/log/cfn-init.log]
                file = /var/log/cfn-init.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-server-2/cfn-init.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cfn-init-cmd.log]
                file = /var/log/cfn-init-cmd.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-server-2/cfn-init-cmd.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cfn-wire.log]
                file = /var/log/cfn-wire.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-server-2/cfn-wire.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/syslog]
                file = /var/log/syslog
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/jmeter-server-2/syslog
                datetime_format = %b %d %H:%M:%S
              mode: '000444'
              owner: root
              group: root
            /home/ubuntu/private_key.pem:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref KeyName
                  - .pem
              mode: '000444'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
            /home/ubuntu/apache-jmeter.tgz:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref JMeterDistributionName
              mode: '000664'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
            /home/ubuntu/jdk-8-linux-x64.tar.gz:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref OracleJDKDistributionName
              mode: '000664'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
          commands:
            01_create_state_directory:
              command: mkdir -p /var/awslogs/state
            02_download_awslogs_agent:
              command: curl -s https://s3.amazonaws.com/aws-cloudwatch/downloads/latest/awslogs-agent-setup.py -O
              cwd: /root
            03_change_permission:
              command: chmod +x ./awslogs-agent-setup.py
              cwd: /root
            04_install_awslogs_agent:
              command: !Join
                - ''
                - - './awslogs-agent-setup.py -n -r '
                  - !Ref 'AWS::Region'
                  - ' -c /etc/awslogs/awslogs.conf'
              cwd: /root
      'AWS::CloudFormation::Authentication':
        S3AccessCreds:
          type: S3
          accessKeyId: !Ref CfnKeys
          secretKey: !GetAtt
            - CfnKeys
            - SecretAccessKey
          buckets:
            - !Ref BucketName
    Properties:
      ImageId: !FindInMap [ AWSRegion2AMI, !Ref "AWS::Region", AMI ]
      InstanceType: !Ref JMeterServerInstanceType
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref LogRoleInstanceProfile
      Tags:
        - Key: Name
          Value: !Join
              - ':'
              - - 'JMeter Server 2'
                - !Ref TestName
      NetworkInterfaces:
        - GroupSet:
            - !Ref InstanceSecurityGroup
          AssociatePublicIpAddress: 'false'
          DeviceIndex: '0'
          DeleteOnTermination: 'true'
          SubnetId: !Ref PrivateSubnet
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          apt-get -y update
          # Install AWS CloudFormation Helper Scripts
          apt-get -y install python-pip
          mkdir aws-cfn-bootstrap-latest
          curl -s https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz -O
          pip install aws-cfn-bootstrap-latest.tar.gz
          tar xzf aws-cfn-bootstrap-latest.tar.gz -C  aws-cfn-bootstrap-latest --strip-components 1
          ln -s aws-cfn-bootstrap-latest/init/ubuntu/cfn-hup /etc/init.d/cfn-hup
          # Initialize
          /usr/local/bin/cfn-init -v --stack ${AWS::StackId} --resource JMeterServer2Instance --region ${AWS::Region}
          # Run setup
          /home/ubuntu/setup/setup-jmeter.sh -g -i /home/ubuntu -d /home/ubuntu/jdk-8-linux-x64.tar.gz -f /home/ubuntu/apache-jmeter.tgz
          # Signal
          /usr/local/bin/cfn-signal -e $? --stack ${AWS::StackId} --resource JMeterServer2Instance --region ${AWS::Region}
    CreationPolicy:
      ResourceSignal:
        Timeout: PT30M
  APIMInstance:
    Type: 'AWS::EC2::Instance'
    DependsOn: [AttachGateway, BucketPolicy]
    Metadata:
      'AWS::CloudFormation::Init':
        config:
          sources:
            /home/ubuntu: !Join
              - ''
              - - 'https://s3.'
                -  !Ref BucketRegion
                - '.amazonaws.com/'
                - !Ref BucketName
                - /
                - !Ref PerformanceAPIMDistributionName
          files:
            /etc/awslogs/awslogs.conf:
              content: !Sub |
                [general]
                state_file = /var/awslogs/state/agent-state

                [/var/log/cloud-init.log]
                file = /var/log/cloud-init.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/apim/cloud-init.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cloud-init-output.log]
                file = /var/log/cloud-init-output.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/apim/cloud-init-output.log
                datetime_format =

                [/var/log/cfn-init.log]
                file = /var/log/cfn-init.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/apim/cfn-init.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cfn-init-cmd.log]
                file = /var/log/cfn-init-cmd.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/apim/cfn-init-cmd.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cfn-wire.log]
                file = /var/log/cfn-wire.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/apim/cfn-wire.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/syslog]
                file = /var/log/syslog
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/apim/syslog
                datetime_format = %b %d %H:%M:%S
              mode: '000444'
              owner: root
              group: root
            /home/ubuntu/private_key.pem:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref KeyName
                  - .pem
              mode: '000444'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
            /home/ubuntu/apim-distribution.zip:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref APIMDistributionName
              mode: '000775'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
            /home/ubuntu/jdk-8-linux-x64.tar.gz:
              source: !Join
              - ''
              - - 'https://s3.'
                - !Ref BucketRegion
                - '.amazonaws.com/'
                - !Ref BucketName
                - /
                - !Ref OracleJDKDistributionName
              mode: '000664'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
            /home/ubuntu/mysql-connector-java.jar:
              source: !Join
              - ''
              - - 'https://s3.'
                - !Ref BucketRegion
                - '.amazonaws.com/'
                - !Ref BucketName
                - /
                - !Ref MysqlConnectorDistributionName
              mode: '000664'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
          commands:
            01_create_state_directory:
              command: mkdir -p /var/awslogs/state
            02_download_awslogs_agent:
              command: curl -s https://s3.amazonaws.com/aws-cloudwatch/downloads/latest/awslogs-agent-setup.py -O
              cwd: /root
            03_change_permission:
              command: chmod +x ./awslogs-agent-setup.py
              cwd: /root
            04_install_awslogs_agent:
              command: !Join
                - ''
                - - './awslogs-agent-setup.py -n -r '
                  - !Ref 'AWS::Region'
                  - ' -c /etc/awslogs/awslogs.conf'
              cwd: /root
      'AWS::CloudFormation::Authentication':
        S3AccessCreds:
          type: S3
          accessKeyId: !Ref CfnKeys
          secretKey: !GetAtt
            - CfnKeys
            - SecretAccessKey
          buckets:
            - !Ref BucketName
    Properties:
      ImageId: !FindInMap [ AWSRegion2AMI, !Ref "AWS::Region", AMI ]
      InstanceType: !Ref APIMInstanceType
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref LogRoleInstanceProfile
      Tags:
        - Key: Name
          Value: !Join
              - ':'
              - - 'APIM'
                - !Ref TestName
      NetworkInterfaces:
        - GroupSet:
            - !Ref InstanceSecurityGroup
          AssociatePublicIpAddress: 'false'
          DeviceIndex: '0'
          DeleteOnTermination: 'true'
          SubnetId: !Ref PrivateSubnet
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          apt-get -y update
          # Install AWS CloudFormation Helper Scripts
          apt-get -y install python-pip
          mkdir aws-cfn-bootstrap-latest
          curl -s https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz -O
          pip install aws-cfn-bootstrap-latest.tar.gz
          tar xzf aws-cfn-bootstrap-latest.tar.gz -C  aws-cfn-bootstrap-latest --strip-components 1
          ln -s aws-cfn-bootstrap-latest/init/ubuntu/cfn-hup /etc/init.d/cfn-hup
          # Initialize
          /usr/local/bin/cfn-init -v --stack ${AWS::StackId} --resource APIMInstance --region ${AWS::Region}
          # Run setup
          /home/ubuntu/setup/setup-apim.sh -j /home/ubuntu/jdk-8-linux-x64.tar.gz  -a /home/ubuntu/apim-distribution.zip -c /home/ubuntu/mysql-connector-java.jar -n ${BackendInstance.PrivateIp} -m ${RDSInstance.Endpoint.Address} -u ${MasterUsername} -p ${MasterUserPassword} -o ubuntu
          # Signal
          /usr/local/bin/cfn-signal -e $? --stack ${AWS::StackId} --resource APIMInstance --region ${AWS::Region}
    CreationPolicy:
      ResourceSignal:
        Timeout: PT30M
  BackendInstance:
    Type: 'AWS::EC2::Instance'
    DependsOn: [AttachGateway, BucketPolicy]
    Metadata:
      'AWS::CloudFormation::Init':
        config:
          sources:
            /home/ubuntu: !Join
              - ''
              - - 'https://s3.'
                -  !Ref BucketRegion
                - '.amazonaws.com/'
                - !Ref BucketName
                - /
                - !Ref PerformanceAPIMDistributionName
          files:
            /etc/awslogs/awslogs.conf:
              content: !Sub |
                [general]
                state_file = /var/awslogs/state/agent-state

                [/var/log/cloud-init.log]
                file = /var/log/cloud-init.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/backend/cloud-init.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cloud-init-output.log]
                file = /var/log/cloud-init-output.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/backend/cloud-init-output.log
                datetime_format =

                [/var/log/cfn-init.log]
                file = /var/log/cfn-init.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/backend/cfn-init.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cfn-init-cmd.log]
                file = /var/log/cfn-init-cmd.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/backend/cfn-init-cmd.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/cfn-wire.log]
                file = /var/log/cfn-wire.log
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/backend/cfn-wire.log
                datetime_format = %Y-%m-%d %H:%M:%S

                [/var/log/syslog]
                file = /var/log/syslog
                log_group_name = ${CloudFormationLogs}
                log_stream_name = {instance_id}/backend/syslog
                datetime_format = %b %d %H:%M:%S
              mode: '000444'
              owner: root
              group: root
            /home/ubuntu/private_key.pem:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref KeyName
                  - .pem
              mode: '000444'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
            /home/ubuntu/jdk-8-linux-x64.tar.gz:
              source: !Join
                - ''
                - - 'https://s3.'
                  - !Ref BucketRegion
                  - '.amazonaws.com/'
                  - !Ref BucketName
                  - /
                  - !Ref OracleJDKDistributionName
              mode: '000664'
              owner: ubuntu
              group: ubuntu
              authentication: "S3AccessCreds"
          commands:
            01_create_state_directory:
              command: mkdir -p /var/awslogs/state
            02_download_awslogs_agent:
              command: curl -s https://s3.amazonaws.com/aws-cloudwatch/downloads/latest/awslogs-agent-setup.py -O
              cwd: /root
            03_change_permission:
              command: chmod +x ./awslogs-agent-setup.py
              cwd: /root
            04_install_awslogs_agent:
              command: !Join
                - ''
                - - './awslogs-agent-setup.py -n -r '
                  - !Ref 'AWS::Region'
                  - ' -c /etc/awslogs/awslogs.conf'
              cwd: /root
      'AWS::CloudFormation::Authentication':
        S3AccessCreds:
          type: S3
          accessKeyId: !Ref CfnKeys
          secretKey: !GetAtt
            - CfnKeys
            - SecretAccessKey
          buckets:
            - !Ref BucketName
    Properties:
      ImageId: !FindInMap [ AWSRegion2AMI, !Ref "AWS::Region", AMI ]
      InstanceType: !Ref BackendInstanceType
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref LogRoleInstanceProfile
      Tags:
        - Key: Name
          Value: !Join
              - ':'
              - - 'Backend'
                - !Ref TestName
      NetworkInterfaces:
        - GroupSet:
            - !Ref InstanceSecurityGroup
          AssociatePublicIpAddress: 'false'
          DeviceIndex: '0'
          DeleteOnTermination: 'true'
          SubnetId: !Ref PrivateSubnet
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          apt-get -y update
          # Install AWS CloudFormation Helper Scripts
          apt-get -y install python-pip
          mkdir aws-cfn-bootstrap-latest
          curl -s https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz -O
          pip install aws-cfn-bootstrap-latest.tar.gz
          tar xzf aws-cfn-bootstrap-latest.tar.gz -C  aws-cfn-bootstrap-latest --strip-components 1
          ln -s aws-cfn-bootstrap-latest/init/ubuntu/cfn-hup /etc/init.d/cfn-hup
          # Initialize
          /usr/local/bin/cfn-init -v --stack ${AWS::StackId} --resource BackendInstance --region ${AWS::Region}
          # Run setup
          /home/ubuntu/setup/setup-netty.sh -g -d /home/ubuntu/jdk-8-linux-x64.tar.gz
          # Signal
          /usr/local/bin/cfn-signal -e $? --stack ${AWS::StackId} --resource BackendInstance --region ${AWS::Region}
    CreationPolicy:
      ResourceSignal:
        Timeout: PT30M
  RDSInstance:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      DBInstanceClass: !Ref DBInstanceClass
      AllocatedStorage: '5'
      Engine: 'MySQL'
      EngineVersion: '5.7'
      BackupRetentionPeriod: '0'
      MasterUsername: !Ref MasterUsername
      MasterUserPassword: !Ref MasterUserPassword
      MultiAZ: false
      DBSubnetGroupName: !Ref APIMDBSubnetGroup
      VPCSecurityGroups:
        - !Ref InstanceSecurityGroup
    CreationPolicy:
      ResourceSignal:
        Timeout: PT30M
    DeletionPolicy: Delete
Outputs:
  JMeterClientPublicIP:
    Description: JMeter Client Public IP
    Value: !GetAtt JMeterClientInstance.PublicIp
